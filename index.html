<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crouså·¥å…·é›†</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 30px;
        }
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Crousimg é¡µé¢æ ·å¼ */
        .crousimg-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .crousimg-controls input[type="number"] {
            width: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .crousimg-controls label {
            font-weight: bold;
        }
        .crousimg-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .crousimg-button:hover {
            background-color: #45a049;
        }
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .preset-buttons .crousimg-button {
            flex: 1;
            background-color: #007bff;
            min-width: 120px;
        }
        .preset-buttons .crousimg-button:hover {
            background-color: #0056b3;
        }
        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
        .thumbnails img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        .thumbnails img:hover {
            transform: scale(1.1);
            border-color: #4CAF50;
        }
        .thumbnails img.selected {
            border-color: #4CAF50;
            transform: scale(1.1);
        }
        .preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            background-color: #fafafa;
        }
        .preview-container img {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .progress-bar-container {
            margin-top: 20px;
            width: 100%;
        }
        .progress-bar {
            width: 0%;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .margin-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .margin-controls div {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .margin-controls label {
            flex: 1;
        }
        .margin-controls input {
            flex: 2;
        }
        .dpi-setting {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .dpi-setting small {
            font-size: 12px;
            color: #666;
        }
        .preview-dimensions {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        .preset-menu {
            margin-top: 10px;
        }
        .preset-menu select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        /* HB1.6 é¡µé¢æ ·å¼ */
        .hb-textarea {
            width: 100%; 
            height: 220px; 
            padding: 12px;
            font-size: 16px; 
            border: 1px solid #ccc;
            border-radius: 6px; 
            margin-bottom: 15px;
            font-family: inherit; 
            background: #fff;
            resize: vertical;
        }
        .hb-controls {
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            flex-wrap: wrap;
        }
        .hb-button {
            padding: 9px 16px; 
            background: #2c3e50; 
            color: white;
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 14px;
        }
        .hb-button:hover { 
            background: #1a252f; 
        }
        .btn-apply { 
            background: #27ae60; 
        }
        .btn-apply:hover { 
            background: #219653; 
        }
        .btn-merge { 
            background: #8E44AD; 
        }
        .btn-merge:hover { 
            background: #7D3C98; 
        }
        #roleInput {
            padding: 9px; 
            font-size: 14px; 
            border: 1px solid #999;
            border-radius: 4px; 
            flex: 1; 
            min-width: 150px;
        }
        #output {
            width: 100%; 
            min-height: 250px; 
            padding: 15px;
            background: #fff; 
            border: 1px solid #ddd;
            border-radius: 6px; 
            line-height: 1.6;
            white-space: pre-wrap; 
            overflow-wrap: break-word;
            font-family: inherit; 
            font-size: 16px;
        }
        .role-legend {
            margin-top: 20px; 
            padding: 15px;
            background: #f8f9fa; 
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .role-item {
            display: flex; 
            align-items: center;
            margin-bottom: 12px; 
            padding: 6px 0;
        }
        .color-box {
            width: 24px; 
            height: 24px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid #aaa;
            cursor: pointer;
        }
        .role-name {
            font-weight: bold;
            flex: 1;
        }
        .color-input {
            width: 80px;
            height: 30px;
            padding: 0 8px;
            border: 1px solid #999;
            border-radius: 4px;
            font-size: 13px;
        }
        .action-cell {
            display: flex; 
            align-items: center;
            margin-left: 10px;
        }
        .apply-btn {
            margin-left: 8px;
            padding: 4px 10px;
            font-size: 12px;
        }
        select.merge-select {
            font-size: 13px; 
            padding: 4px 6px;
            border: 1px solid #999; 
            border-radius: 3px;
            margin: 0 6px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Crouså·¥å…·é›†</h1>
    
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs">
        <button class="tab-button active" data-tab="crousimg">åƒç´ å·¥åŠ</button>
        <button class="tab-button" data-tab="hb16">æ™ºèƒ½ç”»æœ¬</button>
    </div>
    
    <!-- åƒç´ å·¥åŠæ ‡ç­¾é¡µ -->

    <div id="crousimg" class="tab-content active">

        <h1>åƒç´ å·¥åŠ</h1>



        <!-- å·¦ä¾§åŒºåŸŸï¼šç¼©ç•¥å›¾å’Œæ§åˆ¶ -->

        <div>

            <!-- æ–‡ä»¶ä¸Šä¼  -->

            <div class="crousimg-controls">

                <label for="folderInput">é€‰æ‹©æ–‡ä»¶å¤¹:</label>

                <input type="file" id="folderInput" webkitdirectory directory multiple accept="image/*">

                

                <label for="fileInput">é€‰æ‹©æ–‡ä»¶ (å¯å¤šé€‰):</label>

                <input type="file" id="fileInput" multiple accept="image/*" capture="environment" onclick="if(/iPhone|iPad|iPod/i.test(navigator.userAgent)) {this.removeAttribute('capture');}">

            </div>



            <!-- ç¼©ç•¥å›¾åŒºåŸŸ -->

            <div class="thumbnails" id="thumbnails"></div>



            <!-- æ§åˆ¶æŒ‰é’® -->

            <div class="crousimg-controls">

                <div>

                    <label for="widthInput">å®½åº¦ (cm):</label>

                    <input type="number" id="widthInput" value="29.7" min="1" step="0.01">

                </div>

                <div>

                    <label for="heightInput">é«˜åº¦ (cm):</label>

                    <input type="number" id="heightInput" value="21" min="1" step="0.01">

                </div>

                <button class="crousimg-button" id="swapButton">äº¤æ¢å®½é«˜</button>



                <!-- DPI è®¾ç½® -->

                <div class="dpi-setting">

                    <label for="dpiInput">DPI:</label>

                    <input type="number" id="dpiInput" value="300" min="1">

                    <small>(å»ºè®®èŒƒå›´: 300-360)</small>

                </div>



                <!-- è¾¹è·è®¾ç½® -->

                <div class="margin-controls">

                    <div>

                        <label for="marginTopInput">ä¸Šè¾¹è· (mm):</label>

                        <input type="number" id="marginTopInput" value="0" min="0">

                    </div>

                    <div>

                        <label for="marginBottomInput">ä¸‹è¾¹è· (mm):</label>

                        <input type="number" id="marginBottomInput" value="0" min="0">

                    </div>

                    <div>

                        <label for="marginLeftInput">å·¦è¾¹è· (mm):</label>

                        <input type="number" id="marginLeftInput" value="0" min="0">

                    </div>

                    <div>

                        <label for="marginRightInput">å³è¾¹è· (mm):</label>

                        <input type="number" id="marginRightInput" value="0" min="0">

                    </div>

                </div>



                <button class="crousimg-button" id="resizeButton">è°ƒæ•´å›¾ç‰‡å¤§å°</button>

                <button class="crousimg-button" id="exportButton">å¯¼å‡ºä¸ºPDF</button>



                <!-- å¸¸ç”¨å°ºå¯¸æŒ‰é’® -->

                <div class="preset-buttons">

                    <button class="crousimg-button" data-preset="A5">A5 (14.8Ã—21)</button>

                    <button class="crousimg-button" data-preset="A4">A4 (29.7Ã—21)</button>

                    <button class="crousimg-button" data-preset="A3">A3 (29.7Ã—42)</button>

                    <button class="crousimg-button" data-preset="3inch">3å¯¸ (5.1Ã—7.6)</button>

                    <button class="crousimg-button" data-preset="5inch">5å¯¸ (8.9Ã—12.7)</button>

                    <button class="crousimg-button" data-preset="6inch">6å¯¸ (10.2Ã—15.2)</button>

                </div>



                <!-- å…¶ä»–å°ºå¯¸èœå• -->

                <div class="preset-menu">

                    <label for="presetSelect">å…¶ä»–å°ºå¯¸:</label>

                    <select id="presetSelect">

                        <option value="">è¯·é€‰æ‹©å°ºå¯¸</option>

                        <option value="A2">A2 (42Ã—59.4)</option>

                        <option value="A1">A1 (59.4Ã—84.1)</option>

                        <option value="1inch">1å¯¸ (2.5Ã—3.5)</option>

                        <option value="2inch">2å¯¸ (3.5Ã—4.5)</option>

                        <option value="7inch">7å¯¸ (12.7Ã—17.8)</option>

                        <option value="8inch">8å¯¸ (15.2Ã—20.3)</option>

                        <option value="10inch">10å¯¸ (20.3Ã—25.4)</option>

                        <option value="12inch">12å¯¸ (25.4Ã—30.5)</option>

                        <option value="14inch">14å¯¸ (28Ã—35.6)</option>

                        <option value="16inch">16å¯¸ (30.5Ã—40.6)</option>

                        <option value="18inch">18å¯¸ (35.6Ã—45.7)</option>

                        <option value="20inch">20å¯¸ (40.6Ã—50.8)</option>

                        <option value="24inch">24å¯¸ (50.8Ã—61)</option>

                        <option value="30inch">30å¯¸ (61Ã—76.2)</option>

                        <option value="32inch">32å¯¸ (66Ã—81.3)</option>

                        <option value="36inch">36å¯¸ (61Ã—91.4)</option>

                    </select>

                </div>

            </div>



            <!-- è¿›åº¦æ¡ -->

            <div class="progress-bar-container">

                <div class="progress-bar" id="progressBar"></div>

            </div>

        </div>



        <!-- å³ä¾§åŒºåŸŸï¼šé¢„è§ˆ -->

        <div class="preview-container">

            <h2>é¢„è§ˆ</h2>

            <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡" style="display: none;">

            <div class="preview-dimensions" id="previewDimensions"></div>

        </div>

    </div>
    
    <!-- æ™ºèƒ½æœ‰å£°ä¹¦ç”»æœ¬ç€è‰²å™¨æ ‡ç­¾é¡µ -->
    <div id="hb16" class="tab-content">
        <h1>ğŸ¨ æœ‰å£°ä¹¦æ™ºèƒ½ç”»æœ¬</h1>
        <p>å°†æ–‡æœ¬ç²˜è´´åˆ°ä¸Šé¢åç‚¹å‡»"æ™ºèƒ½è‡ªåŠ¨ç€è‰²"ç”Ÿæ•ˆã€‚</p>

        <textarea class="hb-textarea" id="input" placeholder="ä¾‹å¦‚ï¼š
å°æ˜ï¼šä½ å¥½ï¼
ã€å°æ˜ã€‘ä»Šå¤©çœŸå¼€å¿ƒã€‚
å°çº¢ï¼šæˆ‘ä»¬å»ç©å§ï¼
æ—ç™½ï¼šé˜³å…‰æ˜åªšã€‚
"></textarea>

        <div class="hb-controls">
            <button class="hb-button" onclick="autoHighlight()">æ™ºèƒ½è‡ªåŠ¨ç€è‰²</button>
            <input type="text" id="roleInput" placeholder="æŒ‡å®šè§’è‰²å" />
            <button class="hb-button" onclick="manualHighlight()">é€‰ä¸­æ–‡æœ¬æ‰‹åŠ¨ç€è‰²</button>
            <button class="hb-button" id="copyBtn" onclick="copyResult()">å¤åˆ¶ç»“æœ</button>
        </div>

        <h3>ç€è‰²é¢„è§ˆï¼š</h3>
        <div id="output"></div>

        <div class="role-legend" id="legend">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
                <strong>è§’è‰²é¢œè‰²ç®¡ç†ï¼ˆä¿®æ”¹åè¯·ç‚¹å‡»"åº”ç”¨"ï¼‰</strong>
                <div>
                    <button class="hb-button btn-merge" onclick="applyRoleMerge()">âœ“ åº”ç”¨è§’è‰²åˆå¹¶</button>
                    <button class="hb-button btn-apply" onclick="applyAllColorChanges()" style="margin-left:8px;">âœ“ åº”ç”¨æ‰€æœ‰é¢œè‰²</button>
                </div>
            </div>
            <div id="roleList"></div>
        </div>
    </div>
</div>

<script>
    // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // Crousimg åŠŸèƒ½çš„ JavaScript ä»£ç 

    let allImages = [];



    document.getElementById('folderInput').addEventListener('change', function(event) {

        const files = event.target.files;

        const thumbnailsContainer = document.getElementById('thumbnails');

        thumbnailsContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„ç¼©ç•¥å›¾

        allImages = Array.from(files).filter(file => file.type.startsWith('image/'));



        allImages.forEach(file => {

            const reader = new FileReader();



            reader.onload = function(e) {

                const img = document.createElement('img');

                img.src = e.target.result;

                img.alt = file.name;

                img.dataset.file = file;



                img.addEventListener('click', function() {

                    // ç§»é™¤å…¶ä»–å›¾ç‰‡çš„é€‰ä¸­çŠ¶æ€

                    document.querySelectorAll('.thumbnails img').forEach(img => img.classList.remove('selected'));

                    img.classList.add('selected'); // è®¾ç½®å½“å‰å›¾ç‰‡ä¸ºé€‰ä¸­çŠ¶æ€



                    // æ˜¾ç¤ºè°ƒæ•´åçš„å›¾ç‰‡åœ¨é¢„è§ˆçª—å£

                    adjustAndPreviewImage(file);

                });



                thumbnailsContainer.appendChild(img);

            };



            reader.readAsDataURL(file);

        });

    });



    document.getElementById('fileInput').addEventListener('change', function(event) {

        const files = event.target.files;

        const thumbnailsContainer = document.getElementById('thumbnails');

        thumbnailsContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„ç¼©ç•¥å›¾

        allImages = Array.from(files).filter(file => file.type.startsWith('image/'));



        allImages.forEach(file => {

            const reader = new FileReader();



            reader.onload = function(e) {

                const img = document.createElement('img');

                img.src = e.target.result;

                img.alt = file.name;

                img.dataset.file = file;



                img.addEventListener('click', function() {

                    // ç§»é™¤å…¶ä»–å›¾ç‰‡çš„é€‰ä¸­çŠ¶æ€

                    document.querySelectorAll('.thumbnails img').forEach(img => img.classList.remove('selected'));

                    img.classList.add('selected'); // è®¾ç½®å½“å‰å›¾ç‰‡ä¸ºé€‰ä¸­çŠ¶æ€



                    // æ˜¾ç¤ºè°ƒæ•´åçš„å›¾ç‰‡åœ¨é¢„è§ˆçª—å£

                    adjustAndPreviewImage(file);

                });



                thumbnailsContainer.appendChild(img);

            };



            reader.readAsDataURL(file);

        });

    });

    function adjustAndPreviewImage(file) {
        const dpi = parseInt(document.getElementById('dpiInput').value);

        if (isNaN(dpi) || dpi <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„DPIå€¼ï¼');
            return;
        }

        const widthCm = parseFloat(document.getElementById('widthInput').value);
        const heightCm = parseFloat(document.getElementById('heightInput').value);

        if (isNaN(widthCm) || isNaN(heightCm) || widthCm <= 0 || heightCm <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å®½åº¦å’Œé«˜åº¦ï¼');
            return;
        }

        const marginTop = mmToPx(parseInt(document.getElementById('marginTopInput').value));
        const marginBottom = mmToPx(parseInt(document.getElementById('marginBottomInput').value));
        const marginLeft = mmToPx(parseInt(document.getElementById('marginLeftInput').value));
        const marginRight = mmToPx(parseInt(document.getElementById('marginRightInput').value));

               // è½¬æ¢ä¸ºåƒç´ 
               const widthPx = cmToPx(widthCm, dpi);
        const heightPx = cmToPx(heightCm, dpi);

        // æ£€æŸ¥è¾¹è·æ˜¯å¦è¶…å‡ºè®¾å®šå°ºå¯¸
        if (marginTop + marginBottom >= heightPx || marginLeft + marginRight >= widthPx) {
            alert('è¾¹è·è®¾ç½®è¶…å‡ºå›¾ç‰‡å°ºå¯¸ï¼Œè¯·é‡æ–°è¾“å…¥è¾¹è·å€¼ï¼');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;

            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // è®¡ç®—ç”»å¸ƒçš„å®é™…å°ºå¯¸ï¼ˆåŒ…æ‹¬è¾¹è·ï¼‰
                canvas.width = widthPx;
                canvas.height = heightPx;

                // å¡«å……èƒŒæ™¯é¢œè‰²ä¸ºç™½è‰²
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // ç­‰æ¯”ä¾‹ç¼©æ”¾ï¼Œå¤šä½™éƒ¨åˆ†ç•™ç™½
                const scale = Math.min((widthPx - marginLeft - marginRight) / img.width, (heightPx - marginTop - marginBottom) / img.height);
                const x = marginLeft + ((widthPx - marginLeft - marginRight) - img.width * scale) / 2;
                const y = marginTop + ((heightPx - marginTop - marginBottom) - img.height * scale) / 2;

                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

                // æ›´æ–°é¢„è§ˆå›¾ç‰‡
                const previewImage = document.getElementById('previewImage');
                previewImage.src = canvas.toDataURL('image/jpeg');
                previewImage.style.display = 'block';

                // æ›´æ–°é¢„è§ˆå°ºå¯¸æ˜¾ç¤º
                const previewDimensions = document.getElementById('previewDimensions');
                previewDimensions.textContent = `å½“å‰å°ºå¯¸: ${widthCm} cm x ${heightCm} cm`;
            };
        };

        reader.readAsDataURL(file);
    }

    document.getElementById('swapButton').addEventListener('click', function() {
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');

        const temp = widthInput.value;
        widthInput.value = heightInput.value;
        heightInput.value = temp;

        // äº¤æ¢å®½é«˜åç›´æ¥æ›´æ–°é¢„è§ˆ
        const selectedThumbnail = document.querySelector('.thumbnails img.selected');
        if (selectedThumbnail) {
            const file = selectedThumbnail.dataset.file;
            adjustAndPreviewImage(file);
        }
    });

    document.getElementById('resizeButton').addEventListener('click', function() {
        if (allImages.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å¼ å›¾ç‰‡ï¼');
            return;
        }

        const dpi = parseInt(document.getElementById('dpiInput').value);

        if (isNaN(dpi) || dpi <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„DPIå€¼ï¼');
            return;
        }

        const widthCm = parseFloat(document.getElementById('widthInput').value);
        const heightCm = parseFloat(document.getElementById('heightInput').value);

        if (isNaN(widthCm) || isNaN(heightCm) || widthCm <= 0 || heightCm <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å®½åº¦å’Œé«˜åº¦ï¼');
            return;
        }

        const widthPx = cmToPx(widthCm, dpi);
        const heightPx = cmToPx(heightCm, dpi);

        const marginTop = mmToPx(parseInt(document.getElementById('marginTopInput').value));
        const marginBottom = mmToPx(parseInt(document.getElementById('marginBottomInput').value));
        const marginLeft = mmToPx(parseInt(document.getElementById('marginLeftInput').value));
        const marginRight = mmToPx(parseInt(document.getElementById('marginRightInput').value));

        // æ£€æŸ¥è¾¹è·æ˜¯å¦è¶…å‡ºè®¾å®šå°ºå¯¸
        if (marginTop + marginBottom >= heightPx || marginLeft + marginRight >= widthPx) {
            alert('è¾¹è·è®¾ç½®è¶…å‡ºå›¾ç‰‡å°ºå¯¸ï¼Œè¯·é‡æ–°è¾“å…¥è¾¹è·å€¼ï¼');
            return;
        }

        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';

        let completedCount = 0;

        allImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // è®¡ç®—ç”»å¸ƒçš„å®é™…å°ºå¯¸ï¼ˆåŒ…æ‹¬è¾¹è·ï¼‰
                    canvas.width = widthPx;
                    canvas.height = heightPx;

                    // å¡«å……èƒŒæ™¯é¢œè‰²ä¸ºç™½è‰²
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // ç­‰æ¯”ä¾‹ç¼©æ”¾ï¼Œå¤šä½™éƒ¨åˆ†ç•™ç™½
                    const scale = Math.min((widthPx - marginLeft - marginRight) / img.width, (heightPx - marginTop - marginBottom) / img.height);
                    const x = marginLeft + ((widthPx - marginLeft - marginRight) - img.width * scale) / 2;
                    const y = marginTop + ((heightPx - marginTop - marginBottom) - img.height * scale) / 2;

                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

                    // æ›´æ–°è¿›åº¦æ¡
                    completedCount++;
                    const progress = (completedCount / allImages.length) * 100;
                    progressBar.style.width = `${progress}%`;
                };
            };

            reader.readAsDataURL(file);
        });
    });

    document.getElementById('exportButton').addEventListener('click', function() {

        if (allImages.length === 0) {

            alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å¼ å›¾ç‰‡ï¼');

            return;

        }



        const dpi = parseInt(document.getElementById('dpiInput').value);



        if (isNaN(dpi) || dpi <= 0) {

            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„DPIå€¼ï¼');

            return;

        }



        const widthCm = parseFloat(document.getElementById('widthInput').value);

        const heightCm = parseFloat(document.getElementById('heightInput').value);



        if (isNaN(widthCm) || isNaN(heightCm) || widthCm <= 0 || heightCm <= 0) {

            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å®½åº¦å’Œé«˜åº¦ï¼');

            return;

        }



        const widthPx = cmToPx(widthCm, dpi);

        const heightPx = cmToPx(heightCm, dpi);



        const marginTop = mmToPx(parseInt(document.getElementById('marginTopInput').value));

        const marginBottom = mmToPx(parseInt(document.getElementById('marginBottomInput').value));

        const marginLeft = mmToPx(parseInt(document.getElementById('marginLeftInput').value));

        const marginRight = mmToPx(parseInt(document.getElementById('marginRightInput').value));



        // æ£€æŸ¥è¾¹è·æ˜¯å¦è¶…å‡ºè®¾å®šå°ºå¯¸

        if (marginTop + marginBottom >= heightPx || marginLeft + marginRight >= widthPx) {

            alert('è¾¹è·è®¾ç½®è¶…å‡ºå›¾ç‰‡å°ºå¯¸ï¼Œè¯·é‡æ–°è¾“å…¥è¾¹è·å€¼ï¼');

            return;

        }



        // åˆ›å»ºjsPDFå®ä¾‹

        const { jsPDF } = window.jspdf;

        const pdf = new jsPDF({

            orientation: widthCm > heightCm ? 'landscape' : 'portrait',

            unit: 'cm',

            format: [widthCm, heightCm]

        });



        let processedCount = 0;



        // æ›´æ–°è¿›åº¦æ¡

        const progressBar = document.getElementById('progressBar');



        // ç”¨äºå­˜å‚¨å¤„ç†åçš„å›¾ç‰‡æ•°æ®

        const imagePromises = [];



        allImages.forEach((file, index) => {

            const promise = new Promise((resolve) => {

                const reader = new FileReader();

                reader.onload = function(event) {

                    const img = new Image();

                    img.src = event.target.result;



                    img.onload = function() {

                        const canvas = document.createElement('canvas');

                        const ctx = canvas.getContext('2d');



                        // è®¡ç®—ç”»å¸ƒçš„å®é™…å°ºå¯¸ï¼ˆåŒ…æ‹¬è¾¹è·ï¼‰

                        canvas.width = widthPx;

                        canvas.height = heightPx;



                        // å¡«å……èƒŒæ™¯é¢œè‰²ä¸ºç™½è‰²

                        ctx.fillStyle = '#ffffff';

                        ctx.fillRect(0, 0, canvas.width, canvas.height);



                        // ç­‰æ¯”ä¾‹ç¼©æ”¾ï¼Œå¤šä½™éƒ¨åˆ†ç•™ç™½

                        const scale = Math.min((widthPx - marginLeft - marginRight) / img.width, (heightPx - marginTop - marginBottom) / img.height);

                        const x = marginLeft + ((widthPx - marginLeft - marginRight) - img.width * scale) / 2;

                        const y = marginTop + ((heightPx - marginTop - marginBottom) - img.height * scale) / 2;



                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);



                        // å°†è°ƒæ•´åçš„å›¾ç‰‡æ·»åŠ åˆ°PDF

                        const imgData = canvas.toDataURL('image/jpeg');



                        // æ·»åŠ æ–°é¡µé¢ï¼ˆå¦‚æœæ˜¯ç¬¬äºŒå¼ å›¾ç‰‡åŠä»¥åï¼‰

                        if (index > 0) {

                            pdf.addPage([widthCm, heightCm], widthCm > heightCm ? 'landscape' : 'portrait');

                        }



                        pdf.addImage(imgData, 'JPEG', 0, 0, widthCm, heightCm);



                        // æ›´æ–°è¿›åº¦æ¡

                        processedCount++;

                        const progress = (processedCount / allImages.length) * 100;

                        progressBar.style.width = `${progress}%`;



                        resolve();

                    };

                };



                reader.readAsDataURL(file);

            });



            imagePromises.push(promise);

        });



        // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡å¤„ç†å®Œæˆåä¿å­˜PDF

        Promise.all(imagePromises).then(() => {

            pdf.save('adjusted_images.pdf');



            // é‡ç½®è¿›åº¦æ¡

            setTimeout(() => {

                progressBar.style.width = '0%';

            }, 2000);

        });

    });

    // å¸¸ç”¨å°ºå¯¸æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.preset-buttons button').forEach(button => {
        button.addEventListener('click', function() {
            const preset = this.dataset.preset;

            let widthCm, heightCm; // é»˜è®¤å•ä½ä¸ºå˜ç±³
            switch (preset) {
                case 'A5': widthCm = 14.8; heightCm = 21; break;
                case 'A4': widthCm = 29.7; heightCm = 21; break;
                case 'A3': widthCm = 29.7; heightCm = 42; break;
                case '3inch': widthCm = 5.1; heightCm = 7.6; break;
                case '5inch': widthCm = 8.9; heightCm = 12.7; break;
                case '6inch': widthCm = 10.2; heightCm = 15.2; break;
            }

            document.getElementById('widthInput').value = widthCm.toFixed(2); // ä¿ç•™ä¸¤ä½å°æ•°
            document.getElementById('heightInput').value = heightCm.toFixed(2);

            // æ›´æ–°é¢„è§ˆ
            const selectedThumbnail = document.querySelector('.thumbnails img.selected');
            if (selectedThumbnail) {
                const file = selectedThumbnail.dataset.file;
                adjustAndPreviewImage(file);
            }
        });
    });

    // å…¶ä»–å°ºå¯¸èœå•äº‹ä»¶
    document.getElementById('presetSelect').addEventListener('change', function() {
        const preset = this.value;

        if (!preset) return;

        let widthCm, heightCm; // é»˜è®¤å•ä½ä¸ºå˜ç±³
        switch (preset) {
            case 'A2': widthCm = 42; heightCm = 59.4; break;
            case 'A1': widthCm = 59.4; heightCm = 84.1; break;
            case '1inch': widthCm = 2.5; heightCm = 3.5; break;
            case '2inch': widthCm = 3.5; heightCm = 4.5; break;
            case '7inch': widthCm = 12.7; heightCm = 17.8; break;
            case '8inch': widthCm = 15.2; heightCm = 20.3; break;
            case '10inch': widthCm = 20.3; heightCm = 25.4; break;
            case '12inch': widthCm = 25.4; heightCm = 30.5; break;
            case '14inch': widthCm = 28; heightCm = 35.6; break;
            case '16inch': widthCm = 30.5; heightCm = 40.6; break;
            case '18inch': widthCm = 35.6; heightCm = 45.7; break;
            case '20inch': widthCm = 40.6; heightCm = 50.8; break;
            case '24inch': widthCm = 50.8; heightCm = 61; break;
            case '30inch': widthCm = 61; heightCm = 76.2; break;
            case '32inch': widthCm = 66; heightCm = 81.3; break;
            case '36inch': widthCm = 61; heightCm = 91.4; break;
        }

        document.getElementById('widthInput').value = widthCm.toFixed(2); // ä¿ç•™ä¸¤ä½å°æ•°
        document.getElementById('heightInput').value = heightCm.toFixed(2);

        // æ›´æ–°é¢„è§ˆ
        const selectedThumbnail = document.querySelector('.thumbnails img.selected');
        if (selectedThumbnail) {
            const file = selectedThumbnail.dataset.file;
            adjustAndPreviewImage(file);
        }
    });

    // å°†å˜ç±³è½¬æ¢ä¸ºåƒç´ 
    function cmToPx(cm, dpi) {
        return Math.round(cm * dpi / 2.54);
    }

    // å°†æ¯«ç±³è½¬æ¢ä¸ºåƒç´ 
    function mmToPx(mm) {
        const dpi = parseInt(document.getElementById('dpiInput').value);
        return Math.round(mm * dpi / 25.4);
    }
    
    // HB1.6 åŠŸèƒ½çš„ JavaScript ä»£ç 
    let roleColors = { "æ—ç™½": "#555555" };
    let roleMapping = {};
    // ä¸´æ—¶å­˜å‚¨ç”¨æˆ·ä¿®æ”¹çš„é¢œè‰²ï¼ˆæœªåº”ç”¨ï¼‰
    let pendingColorChanges = {};

    const defaultDeepColors = [
      "#C62828", "#1565C0", "#2E7D32", "#5D4037",
      "#6A1B9A", "#004D40", "#BF360C", "#3E2723",
      "#880E4F", "#01579B", "#33691E", "#AD1457"
    ];

    function cleanRoleName(role) {
      return role.trim()
        .replace(/^ã€|ã€‘$/g, '')
        .replace(/^ã€Œ|ã€$/g, '')
        .replace(/^"|"$/g, '')
        .replace(/^â€œ|â€$/g, '')
        .replace(/\s+/g, ' ');
    }

    function getRoleColor(role) {
      const clean = cleanRoleName(role);
      if (roleColors[clean]) return roleColors[clean];
      const color = defaultDeepColors[Object.keys(roleColors).length % defaultDeepColors.length];
      roleColors[clean] = color;
      return color;
    }

    function updateLegend() {
      const list = document.getElementById("roleList");
      const roles = Object.keys(roleColors);
      list.innerHTML = "";

      if (roles.length === 0) {
        list.innerHTML = "<p>æš‚æ— è§’è‰²ã€‚</p>";
        return;
      }

      roles.forEach(role => {
        const currentColor = roleColors[role] || "#000000";
        // æ˜¾ç¤ºå½“å‰å·²åº”ç”¨çš„é¢œè‰²ï¼ˆä¸æ˜¯ pendingï¼‰
        const displayColor = pendingColorChanges[role] !== undefined ? pendingColorChanges[role] : currentColor;

        const div = document.createElement("div");
        div.className = "role-item";
        div.innerHTML = `
          <input type="color" class="color-box" value="${displayColor}" data-role="${role}">
          <div class="role-name">${role}</div>
          <input type="text" class="color-input" value="${displayColor}" data-role="${role}" maxlength="7">
          <div class="action-cell">
            <button class="apply-btn btn-apply" data-role="${role}" onclick="applyColorForRole('${role}')">åº”ç”¨</button>
            <div style="margin-left:12px;">åˆå¹¶åˆ°ï¼š
              <select class="merge-select" data-source="${role}">
                <option value="">â€” é€‰æ‹© â€”</option>
                ${roles.filter(r => r !== role).map(r => 
                  `<option value="${r}">${r}</option>`
                ).join('')}
              </select>
            </div>
          </div>
        `;
        list.appendChild(div);

        // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼ˆä»…æ›´æ–° pendingï¼Œä¸ç«‹å³ç”Ÿæ•ˆï¼‰
        const colorBox = div.querySelector(".color-box");
        const colorInput = div.querySelector(".color-input");

        colorBox.addEventListener("input", function() {
          pendingColorChanges[role] = this.value;
          colorInput.value = this.value;
        });

        colorInput.addEventListener("input", function() {
          let val = this.value.trim();
          if (val && !val.startsWith("#")) val = "#" + val;
          if (/^#[0-9A-F]{6}$/i.test(val)) {
            pendingColorChanges[role] = val;
            colorBox.value = val;
          }
        });
      });
    }

    // åº”ç”¨å•ä¸ªè§’è‰²çš„é¢œè‰²
    function applyColorForRole(role) {
      if (pendingColorChanges[role] !== undefined) {
        roleColors[role] = pendingColorChanges[role];
        delete pendingColorChanges[role];
        rerenderOutput();
        // æ›´æ–°UIæ˜¾ç¤ºå·²åº”ç”¨çŠ¶æ€ï¼ˆç§»é™¤ pending æ ‡è®°ï¼‰
        updateLegend();
        console.log(`âœ… å·²åº”ç”¨é¢œè‰²åˆ°è§’è‰²: ${role}`);
      }
    }

    // ä¸€é”®åº”ç”¨æ‰€æœ‰å¾…å®šé¢œè‰²
    function applyAllColorChanges() {
      let count = 0;
      for (const role in pendingColorChanges) {
        roleColors[role] = pendingColorChanges[role];
        count++;
      }
      if (count > 0) {
        pendingColorChanges = {};
        rerenderOutput();
        updateLegend();
        alert(`âœ… å·²åº”ç”¨ ${count} ä¸ªè§’è‰²çš„é¢œè‰²ï¼`);
      } else {
        alert("â„¹ï¸ æ²¡æœ‰æœªåº”ç”¨çš„é¢œè‰²ä¿®æ”¹ã€‚");
      }
    }

    function applyRoleMerge() {
      const selects = document.querySelectorAll(".merge-select");
      let merged = false;
      for (const sel of selects) {
        const source = sel.dataset.source;
        const target = sel.value;
        if (target) {
          roleMapping[source] = target;
          roleColors[source] = roleColors[target]; // ç»§æ‰¿é¢œè‰²
          merged = true;
        }
      }
      if (merged) {
        rerenderOutput();
        updateLegend();
        alert("âœ… è§’è‰²åˆå¹¶å®Œæˆï¼");
      } else {
        alert("â„¹ï¸ æœªé€‰æ‹©åˆå¹¶é¡¹ã€‚");
      }
    }

    function rerenderOutput() {
      const text = document.getElementById("input").value;
      if (!text.trim()) return;

      const blocks = parseDialogue(text);
      let html = "";

      for (const block of blocks) {
        if (block.type === 'dialogue') {
          let stdRole = cleanRoleName(block.role);
          if (roleMapping[stdRole]) stdRole = roleMapping[stdRole];
          const color = roleColors[stdRole] || getRoleColor(stdRole);
          const safeContent = escapeHtml(block.content).replace(/\n/g, "<br>");
          html += `<span style="color:${color};">${safeContent}</span>\n`;
        } else {
          html += `<span>${escapeHtml(block.content).replace(/\n/g, "<br>")}</span>\n`;
        }
      }

      document.getElementById("output").innerHTML = html;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ===== æ™ºèƒ½è§£æé€»è¾‘ =====
    function parseDialogue(text) {
      const lines = text.split('\n');
      const result = [];
      let i = 0;

      while (i < lines.length) {
        const rawLine = lines[i];
        const line = rawLine.trim();
        if (!line) {
          result.push({ type: 'text', content: rawLine });
          i++; continue;
        }

        let match = line.match(/^([ã€ã€Œ"â€œ]?[\u4e00-\u9fa5a-zA-Z0-9_\s]+?[ã€‘ã€"â€]?)[ï¼š:\sã€€]+(.*)$/);
        if (match && match[1].replace(/[ã€ã€‘ã€Œã€"â€œâ€]/g, '').trim().length <= 12) {
          const roleTag = match[1];
          const roleClean = cleanRoleName(roleTag);
          let dialogue = match[2];
          let contentLines = [roleTag + 'ï¼š' + dialogue];
          i++;
          while (i < lines.length && /^\s/.test(lines[i]) && lines[i].trim()) {
            contentLines.push(lines[i]); i++;
          }
          result.push({ type: 'dialogue', role: roleClean, content: contentLines.join('\n') });
          continue;
        }

        match = line.match(/^([\u4e00-\u9fa5a-zA-Z0-9_]{1,12})[ï¼š:\sã€€]+(.+)$/);
        if (match) {
          const role = match[1];
          let dialogue = match[2];
          let contentLines = [role + 'ï¼š' + dialogue];
          i++;
          while (i < lines.length && /^\s/.test(lines[i]) && lines[i].trim()) {
            contentLines.push(lines[i]); i++;
          }
          result.push({ type: 'dialogue', role: role, content: contentLines.join('\n') });
          continue;
        }

        result.push({ type: 'text', content: rawLine });
        i++;
      }
      return result;
    }

    function autoHighlight() {
      const text = document.getElementById("input").value;
      if (!text.trim()) return;

      // é‡ç½®çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
      roleMapping = {};
      pendingColorChanges = {};

      const blocks = parseDialogue(text);
      roleColors = { "æ—ç™½": "#555555" };

      let html = "";
      for (const block of blocks) {
        if (block.type === 'dialogue') {
          const color = getRoleColor(block.role);
          const safeContent = escapeHtml(block.content).replace(/\n/g, "<br>");
          html += `<span style="color:${color};">${safeContent}</span>\n`;
        } else {
          html += `<span>${escapeHtml(block.content).replace(/\n/g, "<br>")}</span>\n`;
        }
      }

      document.getElementById("output").innerHTML = html;
      updateLegend();
    }

    function manualHighlight() {
      const role = document.getElementById("roleInput").value.trim();
      if (!role) return alert("è¯·è¾“å…¥è§’è‰²å");
      const input = document.getElementById("input");
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const fullText = input.value;
      if (start === end) return alert("è¯·å…ˆé€‰ä¸­ä¸€æ®µæ–‡æœ¬");

      const selected = fullText.substring(start, end);
      const color = getRoleColor(role);
      const safeSelected = escapeHtml(selected);
      const before = escapeHtml(fullText.substring(0, start));
      const after = escapeHtml(fullText.substring(end));

      document.getElementById("output").innerHTML = 
        (before + `<span style="color:${color};">${safeSelected}</span>` + after)
        .replace(/\n/g, "<br>");

      updateLegend();
    }

    function copyResult() {
      const outputDiv = document.getElementById("output");
      if (!outputDiv.innerHTML.trim()) return alert("è¯·å…ˆç”Ÿæˆç»“æœ");

      const pre = document.createElement("pre");
      pre.style.fontFamily = '"Microsoft YaHei", sans-serif';
      pre.style.fontSize = "16px";
      pre.style.whiteSpace = "pre";
      pre.style.margin = "0"; pre.style.padding = "0";
      pre.innerHTML = outputDiv.innerHTML;
      pre.style.position = "fixed"; pre.style.left = "-9999px";
      document.body.appendChild(pre);

      const range = document.createRange();
      range.selectNode(pre);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);

      let success = false;
      try { success = document.execCommand("copy"); } catch (e) {}

      window.getSelection().removeAllRanges();
      document.body.removeChild(pre);

      if (success) {
        alert("âœ… å·²å¤åˆ¶ï¼é¢œè‰²å·²ä¿ç•™ã€‚");
      } else {
        alert("âš ï¸ è¯·æ‰‹åŠ¨å¤åˆ¶é¢„è§ˆåŒºå†…å®¹ã€‚");
      }
    }

    updateLegend();
</script>

<!-- å¼•å…¥JSZipåº“ -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>



<!-- å¼•å…¥jsPDFåº“ -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



</body>

</html>
