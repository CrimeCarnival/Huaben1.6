<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crous å·¥å…·é›† - æ™ºèƒ½ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-hover: #059669;
            --secondary: #3b82f6;
            --secondary-hover: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px;
            color: var(--text-main); line-height: 1.5;
        }
        .container { max-width: 1280px; margin: 0 auto; padding: 0 10px; }
        h1 { text-align: center; font-weight: 800; margin-bottom: 10px; letter-spacing: -0.025em; }
        h1 span { color: var(--primary); }
        h2, h3 { font-weight: 600; margin-top: 0; }

        /* æ ‡ç­¾é¡µ */
        .tabs { display: flex; justify-content: center; background: var(--card-bg); padding: 6px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .tab-button { flex: 1; padding: 12px; background: transparent; border: none; cursor: pointer; font-size: 16px; font-weight: 600; color: var(--text-muted); border-radius: 10px; transition: all 0.3s ease; }
        .tab-button.active { background-color: var(--primary); color: white; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .tool-card { background: var(--card-bg); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 30px; }

        /* --- Crousimg å¸ƒå±€ --- */
        .crousimg-layout { display: grid; grid-template-columns: 400px 1fr; gap: 30px; }
        @media (max-width: 1024px) { .crousimg-layout { grid-template-columns: 1fr; } }
        .control-section { display: flex; flex-direction: column; gap: 20px; }

        .file-upload-group { background: #f9fafb; border: 2px dashed var(--border); border-radius: var(--radius); padding: 20px; text-align: center; transition: border-color 0.3s; }
        .file-upload-group:hover { border-color: var(--primary); }
        .file-upload-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-muted); }
        input[type="file"] { width: 100%; font-size: 14px; }
        input[type="file"]::file-selector-button { background-color: white; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; margin-right: 10px; cursor: pointer; transition: 0.2s; font-weight: 500; }

        /* --- ç¼©ç•¥å›¾åŒºåŸŸ --- */
        .thumbnails {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: var(--radius);
            background: #fff;
            margin-bottom: 10px;
        }
        .thumb-item { position: relative; width: 100%; aspect-ratio: 1; cursor: pointer; transition: transform 0.2s; }
        .thumb-item:hover { transform: translateY(-2px); }
        .thumb-item img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 8px; display: block;
            border: 1px solid var(--border); transition: all 0.2s ease;
        }
        .thumb-item.selected img { border-color: transparent; box-shadow: 0 0 0 3px var(--primary), 0 4px 10px rgba(16, 185, 129, 0.3); }
        .delete-btn {
            position: absolute; top: -6px; right: -6px; width: 20px; height: 20px;
            background-color: #ef4444; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; line-height: 1; cursor: pointer;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0; transition: all 0.2s; z-index: 2;
        }
        .thumb-item:hover .delete-btn, .thumb-item.selected .delete-btn { opacity: 1; }
        .delete-btn:hover { background-color: #dc2626; transform: scale(1.1); }

        /* --- æ§ä»¶ --- */
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: end; }
        .control-item { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 13px; font-weight: 600; }
        input[type="number"], select, input[type="text"] { padding: 10px; border: 1px solid var(--border); border-radius: 8px; width: 100%; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        
        .crousimg-button, .hb-button { padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; width: 100%; }
        .crousimg-button:hover, .hb-button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        
        .preset-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .preset-buttons .crousimg-button { background: white; color: var(--text-main); border: 1px solid var(--border); padding: 8px; font-size: 13px; font-weight: 500; }
        .preset-buttons .crousimg-button:hover { border-color: var(--secondary); color: var(--secondary); background: rgba(59, 130, 246, 0.05); }

        #exportButton { background: var(--secondary); margin-top: 15px; }
        #exportButton:hover { background: var(--secondary-hover); }

        .margin-controls-group { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-top: 15px; }
        .margin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .margin-item { display: flex; align-items: center; gap: 8px; }
        .margin-item span { font-size: 12px; width: 15px; color: var(--text-muted); }

        /* é¢„è§ˆåŒºåŸŸæ ·å¼ */
        .preview-container { background: #eef2f6; border: 1px solid var(--border); border-radius: var(--radius); padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 600px; position: sticky; top: 20px; }
        
        /* é¢„è§ˆé¡¶éƒ¨å¯¼èˆªæ¡ */
        .preview-header {
            display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;
        }
        .nav-btn {
            background: white; border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            font-size: 13px; font-weight: 600; color: var(--text-main);
            transition: all 0.2s; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .nav-btn:hover:not(:disabled) { background: #f9fafb; border-color: var(--primary); color: var(--primary); }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #f3f4f6; }

        .preview-wrapper { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); background: white; line-height: 0; transition: all 0.3s; }
        .preview-container img { max-width: 100%; max-height: 70vh; display: block; }
        .preview-info { margin-top: 20px; display: flex; gap: 15px; }
        .preview-tag { background: rgba(255,255,255,0.9); border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-family: monospace; }

        .progress-bar-container { height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-top: 15px; opacity: 0; transition: opacity 0.3s; }
        .progress-bar-container.show { opacity: 1; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: width 0.2s linear; }

        /* HB1.6 æ ·å¼ */
        .hb-container { gap: 20px; display: flex; flex-direction: column; }
        .hb-textarea { width: 100%; height: 200px; padding: 20px; font-size: 16px; border: 1px solid var(--border); border-radius: var(--radius); resize: vertical; font-family: inherit; }
        .hb-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .hb-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: #f9fafb; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); }
        #output { width: 100%; min-height: 300px; padding: 30px; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); line-height: 1.8; font-size: 18px; white-space: pre-wrap; word-wrap: break-word; }
        .role-legend { background: #fff; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); margin-top: 20px; }
        .role-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6; }
        .btn-apply { background: var(--primary); width: auto; padding: 6px 12px; font-size: 12px; }
        .btn-merge { background: #8b5cf6; width: auto; padding: 6px 12px; font-size: 12px; }

        /* æ–°å¢ï¼šAIé“¾æ¥æŒ‰é’®æ ·å¼ */
        .ai-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #fff;
            border: 1px solid var(--primary);
            color: var(--primary);
            text-decoration: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .ai-link:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Crous <span>å·¥å…·é›†</span></h1>
    
    <div class="tabs">
        <button class="tab-button active" data-tab="crousimg">åƒç´ å·¥åŠ</button>
        <button class="tab-button" data-tab="hb16">æ™ºèƒ½ç”»æœ¬</button>
    </div>
    
    <div id="crousimg" class="tab-content active">
        <div class="crousimg-layout">
            <div class="control-section">
                <div class="tool-card">
                    <h3>ğŸ“‚ å›¾ç‰‡é€‰æ‹©</h3>
                    <div class="file-upload-group">
                        <label>å¯¼å…¥å›¾ç‰‡ (æ”¯æŒç´¯åŠ )</label>
                        <input type="file" id="fileInput" multiple accept="image/*">
                        <div style="height:10px"></div>
                        <input type="file" id="folderInput" webkitdirectory directory multiple accept="image/*" style="display:none">
                        <button class="crousimg-button" onclick="document.getElementById('folderInput').click()" style="background:#fff; color:#333; border:1px solid #ccc;">ğŸ“‚ å¯¼å…¥æ–‡ä»¶å¤¹</button>
                    </div>
                    <div class="thumbnails" id="thumbnails">
                        <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                            æš‚æ— å›¾ç‰‡ï¼Œè¯·ä¸Šä¼ 
                        </div>
                    </div>
                </div>

                <div class="tool-card">
                    <h3>âš™ï¸ å‚æ•°è®¾ç½®</h3>
                    <label style="display:block; margin-bottom:8px;">å¿«é€Ÿå°ºå¯¸</label>
                    <div class="preset-buttons">
                        <button class="crousimg-button" data-preset="A5">A5</button>
                        <button class="crousimg-button" data-preset="A4">A4</button>
                        <button class="crousimg-button" data-preset="A3">A3</button>
                        <button class="crousimg-button" data-preset="3inch">3å¯¸</button>
                        <button class="crousimg-button" data-preset="5inch">5å¯¸</button>
                        <button class="crousimg-button" data-preset="6inch">6å¯¸</button>
                    </div>
                    <select id="presetSelect" style="margin-bottom: 15px;">
                        <option value="">æ›´å¤šå°ºå¯¸...</option>
                        <option value="A2">A2 (42Ã—59.4)</option>
                        <option value="A1">A1 (59.4Ã—84.1)</option>
                        <option value="1inch">1å¯¸ (2.5Ã—3.5)</option>
                        <option value="2inch">2å¯¸ (3.5Ã—4.5)</option>
                        <option value="7inch">7å¯¸ (12.7Ã—17.8)</option>
                        <option value="8inch">8å¯¸ (15.2Ã—20.3)</option>
                        <option value="10inch">10å¯¸ (20.3Ã—25.4)</option>
                        <option value="12inch">12å¯¸ (25.4Ã—30.5)</option>
                        <option value="14inch">14å¯¸ (28Ã—35.6)</option>
                        <option value="16inch">16å¯¸ (30.5Ã—40.6)</option>
                        <option value="18inch">18å¯¸ (35.6Ã—45.7)</option>
                        <option value="20inch">20å¯¸ (40.6Ã—50.8)</option>
                        <option value="24inch">24å¯¸ (50.8Ã—61)</option>
                        <option value="30inch">30å¯¸ (61Ã—76.2)</option>
                        <option value="32inch">32å¯¸ (66Ã—81.3)</option>
                        <option value="36inch">36å¯¸ (61Ã—91.4)</option>
                    </select>

                    <div class="controls-grid">
                        <div class="control-item"><label>å®½ (cm)</label><input type="number" id="widthInput" value="29.7" step="0.01"></div>
                        <div class="control-item"><label>é«˜ (cm)</label><input type="number" id="heightInput" value="21" step="0.01"></div>
                        <div class="control-item"><label>DPI</label><input type="number" id="dpiInput" value="300"></div>
                        <div style="display:flex; gap:8px; align-self:end; height:42px;">
                            <button class="crousimg-button" id="rotateButton" style="background-color: var(--text-main); padding: 0 10px;" title="æ—‹è½¬å½“å‰å›¾ç‰‡">â†» æ—‹è½¬</button>
                            <button class="crousimg-button" id="swapButton" style="background-color: var(--text-main); padding: 0 10px;" title="äº¤æ¢ç”»å¸ƒå®½é«˜">âŸ· äº¤æ¢</button>
                        </div>
                    </div>

                    <div class="margin-controls-group">
                        <span class="margin-title">è¾¹è· (mm)</span>
                        <div class="margin-grid">
                            <div class="margin-item"><span>ä¸Š</span><input type="number" id="marginTopInput" value="0"></div>
                            <div class="margin-item"><span>ä¸‹</span><input type="number" id="marginBottomInput" value="0"></div>
                            <div class="margin-item"><span>å·¦</span><input type="number" id="marginLeftInput" value="0"></div>
                            <div class="margin-item"><span>å³</span><input type="number" id="marginRightInput" value="0"></div>
                        </div>
                    </div>

                    <button class="crousimg-button" id="exportButton">ğŸš€ æ‰¹é‡å¯¼å‡º PDF</button>
                    <div class="progress-bar-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
                </div>
            </div>

            <div class="preview-section">
                <div class="preview-container">
                    <!-- é¢„è§ˆåŒºåŸŸé¡¶éƒ¨å¯¼èˆªæ  -->
                    <div class="preview-header">
                        <button class="nav-btn" id="prevBtn" disabled>â—€ ä¸Šä¸€å¼ </button>
                        <h3 style="margin:0; color:var(--text-muted); font-size:14px;">æ•ˆæœé¢„è§ˆ</h3>
                        <button class="nav-btn" id="nextBtn" disabled>ä¸‹ä¸€å¼  â–¶</button>
                    </div>

                    <div class="preview-wrapper">
                        <img id="previewImage" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2ZmZmZmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTQ5NDk0IiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCI+56m655m955S75biDIMK3IOmjjOiopzwvdGV4dD48L3N2Zz4=">
                    </div>
                    <div class="preview-info">
                         <div class="preview-tag" id="previewSizeTag">å°ºå¯¸: 29.7 x 21 cm</div>
                         <div class="preview-tag" id="previewPxTag">åƒç´ : 3508 x 2480 px</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="hb16" class="tab-content">
        <div class="tool-card hb-container">
            <div style="text-align: center; margin-bottom: 10px;">
                <h2>ğŸ¨ æœ‰å£°ä¹¦æ™ºèƒ½ç”»æœ¬</h2>
                <p style="color: var(--text-muted);">å»ºè®®å°†æ–‡æœ¬ååŠ æç¤ºè¯#åˆ†ææ–‡æœ¬ï¼Œå°†è§’è‰²å°è¯å‰ç”¨ã€**ï¼šã€‘æ ‡æ³¨ã€‚#  #ç”¨æœ‰å£°æ¼”æ’­çš„æ–¹æ³•ï¼Œå°†æ¯æ®µå¥å­åæ ‡æ³¨ï¼ˆæƒ…ç»ªï¼‰#ï¼Œå‘AIç”Ÿæˆåç²˜è´´æ–‡æœ¬</p>
                <!-- æ–°å¢ï¼šAIé“¾æ¥æŒ‰é’® -->
                <a href="https://chat.qwen.ai" target="_blank" class="ai-link">
                    ğŸ¤– æ‰“å¼€é€šä¹‰åƒé—® (Qwen AI) è¾…åŠ©åˆ›ä½œ
                </a>
            </div>
            <textarea class="hb-textarea" id="input" placeholder="åœ¨æ­¤ç²˜è´´å‰§æœ¬å†…å®¹..."></textarea>
            <div class="hb-controls">
                <button class="hb-button" onclick="autoHighlight()" style="width:auto">âœ¨ æ™ºèƒ½ç€è‰²</button>
                <input type="text" id="roleInput" placeholder="è§’è‰²å" style="width: 150px">
                <button class="hb-button" onclick="manualHighlight()" style="background-color: var(--text-main); width:auto">æ‰‹åŠ¨ç€è‰²</button>
                <button class="hb-button" onclick="copyResult()" style="background-color: #333; width:auto; margin-left:auto">ğŸ“‹ å¤åˆ¶</button>
            </div>
            <div id="output"></div>
            <div class="role-legend" id="legend"><div id="roleList"></div></div>
        </div>
    </div>
</div>

<script>
    // ---------------- æ ‡ç­¾é¡µé€»è¾‘ ----------------
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(button.getAttribute('data-tab')).classList.add('active');
        });
    });

    // ---------------- åƒç´ å·¥åŠæ ¸å¿ƒé€»è¾‘ ----------------
    let allImages = [];
    let currentImgObject = null;
    let selectedIndex = -1; 

    // å¤„ç†æ–‡ä»¶è¾“å…¥
    ['folderInput', 'fileInput'].forEach(id => {
        document.getElementById(id).addEventListener('change', function(event) {
            const newFiles = Array.from(event.target.files).filter(file => file.type.startsWith('image/'));
            if (newFiles.length === 0) return;

            const newItems = newFiles.map(f => ({ file: f, rotation: 0 }));
            allImages = allImages.concat(newItems);
            
            if (selectedIndex === -1) {
                selectedIndex = 0;
            }
            
            renderThumbnails();
            loadAndPreviewImage(allImages[selectedIndex]);
            updateNavButtons(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
            this.value = '';
        });
    });

    // åˆ‡æ¢å›¾ç‰‡å‡½æ•°
    function switchImage(direction) {
        const newIndex = selectedIndex + direction;
        if (newIndex >= 0 && newIndex < allImages.length) {
            selectedIndex = newIndex;
            renderThumbnails(); // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€
            loadAndPreviewImage(allImages[selectedIndex]);
            updateNavButtons(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
        }
    }

    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    function updateNavButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (allImages.length === 0) {
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }

        prevBtn.disabled = selectedIndex <= 0;
        nextBtn.disabled = selectedIndex >= allImages.length - 1;
    }

    // ç»‘å®šåˆ‡æ¢æŒ‰é’®äº‹ä»¶
    document.getElementById('prevBtn').addEventListener('click', () => switchImage(-1));
    document.getElementById('nextBtn').addEventListener('click', () => switchImage(1));

    function renderThumbnails() {
        const container = document.getElementById('thumbnails');
        container.innerHTML = '';

        if (allImages.length === 0) {
            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">æš‚æ— å›¾ç‰‡ï¼Œè¯·ä¸Šä¼ </div>';
            selectedIndex = -1;
            document.getElementById('previewImage').src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2ZmZmZmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTQ5NDk0IiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCI+56m655m955S75biDIMK3IOmjjOiopzwvdGV4dD48L3N2Zz4=";
            updateNavButtons();
            return;
        }

        allImages.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `thumb-item ${index === selectedIndex ? 'selected' : ''}`;
            
            const img = document.createElement('img');
            img.alt = item.file.name;
            const reader = new FileReader();
            reader.onload = e => img.src = e.target.result;
            reader.readAsDataURL(item.file);

            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerHTML = '&times;';
            delBtn.title = 'åˆ é™¤';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                deleteImage(index);
            };

            itemDiv.onclick = () => {
                selectedIndex = index;
                renderThumbnails(); 
                loadAndPreviewImage(item);
                updateNavButtons();
            };

            itemDiv.appendChild(img);
            itemDiv.appendChild(delBtn);
            container.appendChild(itemDiv);
        });
    }

    function deleteImage(index) {
        allImages.splice(index, 1);
        if (allImages.length === 0) {
            selectedIndex = -1;
        } else if (index === selectedIndex) {
            selectedIndex = index < allImages.length ? index : allImages.length - 1;
        } else if (index < selectedIndex) {
            selectedIndex--;
        }
        renderThumbnails();
        updateNavButtons();
        if (selectedIndex !== -1) {
            loadAndPreviewImage(allImages[selectedIndex]);
        }
    }

    function loadAndPreviewImage(item) {
        if(!item) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                currentImgObject = img;
                redrawPreview();
            };
        };
        reader.readAsDataURL(item.file);
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function getRotatedSource(img, rotation) {
        if (rotation === 0) return img;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        if (rotation === 90 || rotation === 270) {
            canvas.width = img.height;
            canvas.height = img.width;
        } else {
            canvas.width = img.width;
            canvas.height = img.height;
        }
        
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(rotation * Math.PI / 180);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        return canvas;
    }

    function redrawPreview() {
        if (!currentImgObject || selectedIndex === -1) return;
        
        const rotation = allImages[selectedIndex].rotation;
        const sourceImg = getRotatedSource(currentImgObject, rotation);

        const dpi = parseInt(document.getElementById('dpiInput').value) || 300;
        const widthCm = parseFloat(document.getElementById('widthInput').value) || 29.7;
        const heightCm = parseFloat(document.getElementById('heightInput').value) || 21;
        const widthPx = cmToPx(widthCm, dpi);
        const heightPx = cmToPx(heightCm, dpi);
        
        document.getElementById('previewSizeTag').textContent = `å°ºå¯¸: ${widthCm} x ${heightCm} cm`;
        document.getElementById('previewPxTag').textContent = `åƒç´ : ${widthPx} x ${heightPx} px`;

        const marginTop = mmToPx(parseInt(document.getElementById('marginTopInput').value) || 0);
        const marginBottom = mmToPx(parseInt(document.getElementById('marginBottomInput').value) || 0);
        const marginLeft = mmToPx(parseInt(document.getElementById('marginLeftInput').value) || 0);
        const marginRight = mmToPx(parseInt(document.getElementById('marginRightInput').value) || 0);

        if (widthPx <= 0 || heightPx <= 0) return;

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = widthPx;
        canvas.height = heightPx;

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const availW = widthPx - marginLeft - marginRight;
        const availH = heightPx - marginTop - marginBottom;

        if (availW > 0 && availH > 0) {
            const scale = Math.min(availW / sourceImg.width, availH / sourceImg.height);
            const drawW = sourceImg.width * scale;
            const drawH = sourceImg.height * scale;
            const x = marginLeft + (availW - drawW) / 2;
            const y = marginTop + (availH - drawH) / 2;
            ctx.drawImage(sourceImg, x, y, drawW, drawH);
        }
        document.getElementById('previewImage').src = canvas.toDataURL('image/jpeg');
    }

    const debouncedRedraw = debounce(redrawPreview, 100);
    ['widthInput', 'heightInput', 'dpiInput', 'marginTopInput', 'marginBottomInput', 'marginLeftInput', 'marginRightInput'].forEach(id => {
        document.getElementById(id).addEventListener('input', debouncedRedraw);
    });

    document.getElementById('swapButton').addEventListener('click', function() {
        const w = document.getElementById('widthInput');
        const h = document.getElementById('heightInput');
        [w.value, h.value] = [h.value, w.value];
        redrawPreview();
    });

    document.getElementById('rotateButton').addEventListener('click', function() {
        if (selectedIndex === -1) return alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡');
        allImages[selectedIndex].rotation = (allImages[selectedIndex].rotation + 90) % 360;
        redrawPreview();
    });

    document.querySelectorAll('.preset-buttons button').forEach(button => {
        button.addEventListener('click', function() { applyPreset(this.dataset.preset); });
    });
    document.getElementById('presetSelect').addEventListener('change', function() { applyPreset(this.value); });

    function applyPreset(preset) {
        if (!preset) return;
        let w, h;
        switch (preset) {
            case 'A5': w = 14.8; h = 21; break;
            case 'A4': w = 29.7; h = 21; break;
            case 'A3': w = 29.7; h = 42; break;
            case 'A2': w = 42; h = 59.4; break;
            case 'A1': w = 59.4; h = 84.1; break;
            case '1inch': w = 2.5; h = 3.5; break;
            case '2inch': w = 3.5; h = 4.5; break;
            case '3inch': w = 5.1; h = 7.6; break;
            case '5inch': w = 8.9; h = 12.7; break;
            case '6inch': w = 10.2; h = 15.2; break;
            case '7inch': w = 12.7; h = 17.8; break;
            case '8inch': w = 15.2; h = 20.3; break;
            case '10inch': w = 20.3; h = 25.4; break;
            case '12inch': w = 25.4; h = 30.5; break;
            case '14inch': w = 28; h = 35.6; break;
            case '16inch': w = 30.5; h = 40.6; break;
            case '18inch': w = 35.6; h = 45.7; break;
            case '20inch': w = 40.6; h = 50.8; break;
            case '24inch': w = 50.8; h = 61; break;
            case '30inch': w = 61; h = 76.2; break;
            case '32inch': w = 66; h = 81.3; break;
            case '36inch': w = 61; h = 91.4; break;
        }
        if (w && h) { document.getElementById('widthInput').value = w; document.getElementById('heightInput').value = h; redrawPreview(); }
    }
    function cmToPx(cm, dpi) { return Math.round(cm * dpi / 2.54); }
    function mmToPx(mm) { const dpi = parseInt(document.getElementById('dpiInput').value); return Math.round(mm * dpi / 25.4); }

    document.getElementById('exportButton').addEventListener('click', async function() {
        if (allImages.length === 0) return alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼');
        const { jsPDF } = window.jspdf;
        const widthCm = parseFloat(document.getElementById('widthInput').value);
        const heightCm = parseFloat(document.getElementById('heightInput').value);
        const dpi = parseInt(document.getElementById('dpiInput').value);
        const widthPx = cmToPx(widthCm, dpi);
        const heightPx = cmToPx(heightCm, dpi);
        const marginTop = mmToPx(parseInt(document.getElementById('marginTopInput').value)||0);
        const marginBottom = mmToPx(parseInt(document.getElementById('marginBottomInput').value)||0);
        const marginLeft = mmToPx(parseInt(document.getElementById('marginLeftInput').value)||0);
        const marginRight = mmToPx(parseInt(document.getElementById('marginRightInput').value)||0);

        const pdf = new jsPDF({ orientation: widthCm > heightCm ? 'landscape' : 'portrait', unit: 'cm', format: [widthCm, heightCm] });
        const progressBar = document.getElementById('progressBar');
        document.getElementById('progressContainer').classList.add('show');
        
        for (let i = 0; i < allImages.length; i++) {
            if (i > 0) pdf.addPage([widthCm, heightCm], widthCm > heightCm ? 'landscape' : 'portrait');
            await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = widthPx; canvas.height = heightPx;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        const sourceImg = getRotatedSource(img, allImages[i].rotation);
                        
                        const availW = widthPx - marginLeft - marginRight;
                        const availH = heightPx - marginTop - marginBottom;
                        const scale = Math.min(availW / sourceImg.width, availH / sourceImg.height);
                        const x = marginLeft + (availW - sourceImg.width * scale) / 2;
                        const y = marginTop + (availH - sourceImg.height * scale) / 2;
                        ctx.drawImage(sourceImg, x, y, sourceImg.width * scale, sourceImg.height * scale);
                        pdf.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, widthCm, heightCm);
                        progressBar.style.width = `${((i + 1) / allImages.length) * 100}%`;
                        resolve();
                    };
                };
                reader.readAsDataURL(allImages[i].file);
            });
        }
        pdf.save('Crous_Export.pdf');
        setTimeout(() => { progressBar.style.width = '0%'; document.getElementById('progressContainer').classList.remove('show'); }, 1000);
    });

    // ---------------- æ™ºèƒ½ç”»æœ¬é€»è¾‘ ----------------
    let roleColors = {"æ—ç™½": "#555555"}, roleMapping = {}, pendingColorChanges = {};
    const defaultDeepColors = ["#C62828", "#1565C0", "#2E7D32", "#5D4037", "#6A1B9A", "#004D40", "#BF360C", "#3E2723", "#880E4F", "#01579B", "#33691E", "#AD1457"];
    function cleanRoleName(r){return r.trim().replace(/^ã€|ã€‘$/g,'').replace(/^ã€Œ|ã€$/g,'').replace(/^"|"$/g,'').replace(/^â€œ|â€$/g,'').replace(/\s+/g,' ')}
    function getRoleColor(r){const c=cleanRoleName(r);if(roleColors[c])return roleColors[c];const col=defaultDeepColors[Object.keys(roleColors).length%defaultDeepColors.length];roleColors[c]=col;return col;}
    function updateLegend(){const l=document.getElementById("roleList");const rs=Object.keys(roleColors);l.innerHTML="";if(!rs.length)return l.innerHTML="<p>æš‚æ— è§’è‰²</p>";rs.forEach(r=>{
        const c=pendingColorChanges[r]!==undefined?pendingColorChanges[r]:(roleColors[r]||"#000");
        const d=document.createElement("div");d.className="role-item";
        d.innerHTML=`<input type="color" class="color-box" value="${c}" data-role="${r}"><div class="role-name">${r}</div><input type="text" class="color-input" value="${c}" maxlength="7"><div class="action-cell"><button class="btn-apply" onclick="applyColor('${r}')">åº”ç”¨</button></div>`;
        l.appendChild(d);
        d.querySelector(".color-box").oninput=function(){pendingColorChanges[r]=this.value;d.querySelector(".color-input").value=this.value};
        d.querySelector(".color-input").oninput=function(){if(/^#[0-9A-F]{6}$/i.test(this.value)){pendingColorChanges[r]=this.value;d.querySelector(".color-box").value=this.value}};
    })}
    window.applyColor=function(r){if(pendingColorChanges[r]){roleColors[r]=pendingColorChanges[r];delete pendingColorChanges[r];rerenderOutput();updateLegend()}}
    function rerenderOutput(){
        const blocks=parseDialogue(document.getElementById("input").value);let html="";
        for(const b of blocks){const t=b.content.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
        if(b.type==='dialogue'){let r=cleanRoleName(b.role);if(roleMapping[r])r=roleMapping[r];html+=`<div style="color:${roleColors[r]||getRoleColor(r)};min-height:1.5em">${t}</div>`}else{html+=`<div style="min-height:1.5em">${t}</div>`}}
        document.getElementById("output").innerHTML=html;
    }
    function parseDialogue(t){const ls=t.split('\n'),res=[];let i=0;while(i<ls.length){const l=ls[i].trim();if(!l){res.push({type:'text',content:""});i++;continue}let m=l.match(/^([ã€ã€Œ"â€œ]?[\u4e00-\u9fa5a-zA-Z0-9_\s]+?[ã€‘ã€"â€]?)[ï¼š:\sã€€]+(.*)$/);if(m&&m[1].replace(/[ã€ã€‘ã€Œã€"â€œâ€]/g,'').trim().length<=12){let c=[m[1]+'ï¼š'+m[2]];i++;while(i<ls.length&&/^\s/.test(ls[i])&&ls[i].trim()){c.push(ls[i]);i++}res.push({type:'dialogue',role:cleanRoleName(m[1]),content:c.join('\n')});continue}res.push({type:'text',content:ls[i]});i++}return res}
    window.autoHighlight=function(){roleMapping={};pendingColorChanges={};roleColors={"æ—ç™½":"#555555"};rerenderOutput();updateLegend()}
    window.manualHighlight=function(){const r=document.getElementById("roleInput").value.trim();if(!r)return alert("è¾“å…¥è§’è‰²å");const s=window.getSelection();if(!s.rangeCount)return alert("é€‰ä¸­æ–‡æœ¬");const rg=s.getRangeAt(0);const t=rg.toString();if(!t)return;const sp=document.createElement("span");sp.style.color=getRoleColor(r);sp.textContent=t;rg.deleteContents();rg.insertNode(sp);updateLegend()}
    window.copyResult=function(){const r=document.createRange();r.selectNode(document.getElementById("output"));window.getSelection().removeAllRanges();window.getSelection().addRange(r);document.execCommand("copy");alert("å·²å¤åˆ¶");window.getSelection().removeAllRanges()}
    updateLegend();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
